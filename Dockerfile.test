# Dockerfile.test - For running SDXL worker tests in isolation
# Usage:
#   docker build -f Dockerfile.test -t lcm-sd-test .
#   docker run --rm --gpus all -v /path/to/models:/models:ro lcm-sd-test

ARG BACKEND=cuda
ARG BASE_IMAGE=nvidia/cuda:12.8.0-runtime-ubuntu22.04

FROM ${BASE_IMAGE}

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    build-essential \
    git \
    python3.12 \
    python3.12-dev \
    python3.12-distutils \
    python3-pip \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Upgrade pip
RUN python3.12 -m pip install --no-cache-dir --upgrade pip

# Copy requirements first (for better layer caching)
COPY requirements.txt /app/requirements.txt

# Install Python dependencies
RUN pip install --no-cache-dir -r /app/requirements.txt

# Install test dependencies
RUN pip install --no-cache-dir \
    pytest>=7.0 \
    pytest-timeout \
    pytest-asyncio

# Copy application code
COPY backends/ /app/backends/
COPY server/ /app/server/
COPY tests/ /app/tests/
COPY *.py /app/

# Copy test runner
COPY run_sdxl_tests.sh /app/run_sdxl_tests.sh
RUN chmod +x /app/run_sdxl_tests.sh

# Set environment defaults for testing
ENV PYTHONPATH=/app
ENV LOG_LEVEL=INFO

# Default command runs the SDXL tests
CMD ["pytest", "tests/test_sdxl_worker.py", "-v", "-s", "--tb=short", "-p", "no:cov"]
